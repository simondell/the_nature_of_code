<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Accelerating with Perlin noise as force</title>

	<style>
	canvas {
		border: 1px solid grey;
	}
	</style>
</head>
<body>
	<script src="../../vendor/noisejs/perlin.js"></script>
	<script src="../../lib/vector_2d.js"></script>
	<script src="../../lib/map_to_range.js"></script>

	<script>
	// A Mover "class"
	function Mover(context, x, y) {
		this.context = context;
		this.position = new Vector2D(x, y);
		this.next_position = new Vector2D(x, y);
		this.velocity = new Vector2D(0, 0);
		this.acceleration = new Vector2D();
		this.tx = Math.random();
		this.ty = Math.random()* 10000;
	}

	Mover.prototype.step = function () {
		var t = 0.03
		var perlin_x = noise.perlin2( this.tx, t );
		var perlin_y = noise.perlin2( t, this.ty );
		this.acceleration.set(
			mapToRange( perlin_x, -1, 1, -0.1, 0.1 ),
			mapToRange( perlin_y, -1, 1,  -0.1, 0.1 )
		);

		this.velocity.add( this.acceleration );
		this.velocity.limit( 50 );
		this.next_position.add( this.velocity );

		this.tx += 0.01;
		this.ty += 0.01;

		return this;
	}

	Mover.prototype.display = function () {
		this.context.lineWidth = 5;
		this.context.strokeStyle = 'rgba(0,0,0,0.1)';
		this.context.moveTo( this.position.x, this.position.y );
		this.context.lineTo( this.next_position.x, this.next_position.y );
		this.context.stroke();

		this.position.set( this.next_position );
		if( this.position.x < 0 ) {
			this.position.x = canvasWidth;
			this.next_position.x = canvasWidth;
		}

		if( this.position.x > canvasWidth ) {
			this.position.x = 0;
			this.next_position.x = 0;
		}

		if( this.position.y < 0 ) {
			this.position.y = canvasHeight;
			this.next_position.y = canvasHeight;
		}

		if( this.position.y > canvasHeight ) {
			this.position.y = 0;
			this.next_position.y = 0;
		}

		return this;
	}



	//
	// event handlers
	//
	function setMouseXY ( event ) {
		mouse.set( event.pageX, event.pageY );
	}

	function setMouseOver () {
		mouse.over = true;
	}

	function setMouseOut () {
		mouse.over = false;
	}



	//
	// draw it all
	//
	var mouse = new Vector2D();
	var canvas;
	var canvasWidth = 640;
	var canvasHeight = 360;

	mouse.over = false;

	canvas = document.createElement( 'canvas' );
	canvas.width = canvasWidth;
	canvas.height = canvasHeight;
	canvas.addEventListener( 'mouseenter', setMouseOver );
	canvas.addEventListener( 'mouseenter', setMouseOut );
	canvas.addEventListener( 'mouseenter', setMouseXY );
	canvas.addEventListener( 'mousemove', setMouseXY );
	document.body.appendChild( canvas );

	mover = new Mover( canvas.getContext( '2d' ), canvasWidth / 2, canvasHeight / 2 );

	setTimeout( function draw () {
		mover.step()
		mover.display();
		setTimeout( draw, 20 );
	});
	</script>
</body>
</html>
